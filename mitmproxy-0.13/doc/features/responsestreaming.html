<!DOCTYPE html>
<html>
    <head>
        <title>mitmproxy 0.13 - Response Streaming</title>
        


<link  href="../01-vendor.css" type="text/css" rel="StyleSheet"/>
<link  href="../02-app.css" type="text/css" rel="StyleSheet"/>
<link  href="../syntax.css" type="text/css" rel="StyleSheet"/>

    </head>
    <body>
        <div class="navbar navbar-default navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="../index.html">
                        <img height="20px" src="../mitmproxy-long.png"/>
                    </a>
                </div>
                <div class="navbar-header navbar-right">
                    <a class="navbar-brand" hre="#">0.13 docs</a>
                </div>
            </div>
        </div>


        <div class="container">
          <div class="row">
            <div class="col-md-3">
                <ul class="nav nav-sidebar">
    <li><a href="../index.html">Introduction</a></li>
    <li><a href="../install.html">Installation</a></li>
    <li><a href="../certinstall.html">About Certificates</a></li>
    <li><a href="../howmitmproxy.html">How mitmproxy works</a></li>
    <li><a href="../modes.html">Modes of Operation</a></li>

    <li class="nav-header">Tools</li>
        <li><a href="../mitmproxy.html">mitmproxy</a></li>
        <li><a href="../mitmdump.html">mitmdump</a></li>
        <li><a href="../config.html">configuration</a></li>

    <li class="nav-header">Features</li>
        <li><a href="anticache.html">Anticache</a></li>

        <li><a href="filters.html">Filter expressions</a></li>
        <li><a href="replacements.html">Replacements</a></li>
        <li><a href="clientreplay.html">Client-side replay</a></li>
        <li><a href="serverreplay.html">Server-side replay</a></li>
        <li><a href="setheaders.html">Set Headers</a></li>
        <li><a href="passthrough.html">Ignore Domains</a></li>
        <li><a href="proxyauth.html">Proxy Authentication</a></li>
        <li><a href="reverseproxy.html">Reverse proxy mode</a></li>
        <li class="active"><a href="responsestreaming.html">Response Streaming</a></li>
        <li><a href="socksproxy.html">SOCKS Mode</a></li>
        <li><a href="sticky.html">Sticky cookies and auth</a></li>
        <li><a href="tcpproxy.html">TCP Proxy</a></li>
        <li><a href="upstreamproxy.html">Upstream proxy mode</a></li>
        <li><a href="upstreamcerts.html">Upstream Certs</a></li>


    <li class="nav-header">Transparent Proxying</li>
        <li><a href="../transparent.html">Overview</a></li>
        <li><a href="../transparent/linux.html">Linux</a></li>
        <li><a href="../transparent/osx.html">OSX</a></li>

    <li class="nav-header">Scripting</li>
        <li><a href="../scripting/inlinescripts.html">Inline Scripts</a></li>
        <li><a href="../scripting/libmproxy.html">libmproxy</a></li>

    <li class="nav-header">Tutorials</li>
        <li><a href="../tutorials/30second.html">Client playback: a 30 second example</a></li>
        <li><a href="../tutorials/gamecenter.html">Setting highscores on Apple's GameCenter</a></li>
        <li><a href="../tutorials/transparent-dhcp.html">Transparently proxify virtual machines</a></li>

    <li class="nav-header">Hacking</li>
        <li><a href="../dev/architecture.html">Architecture</a></li>
        <li><a href="../dev/testing.html">Testing</a></li>
        <li><a href="../dev/sslkeylogfile.html">TLS Master Secrets</a></li>
</ul>

            </div>
            <div class="col-md-9">
                <div class="page-header">
                <h1>Response Streaming</h1>
                </div>
                <p>By using mitmproxy's streaming feature, response contents can be passed to the client incrementally before they have been fully received by the proxy.
This is especially useful for large binary files such as videos, where buffering the whole file slows down the client's browser.</p>

<p>By default, mitmproxy will read the entire response, perform any indicated
manipulations on it and then send the (possibly modified) response to
the client. In some cases this is undesirable and you may wish to "stream"
the reponse back to the client. When streaming is enabled, the response is
not buffered on the proxy but directly sent back to the client instead.</p>

<h2>On the command-line</h2>

<p>Streaming can be enabled on the command line for all response bodies exceeding a certain size.  The SIZE argument understands
k/m/g suffixes, e.g. 3m for 3 megabytes.</p>

<table class="table">
    <tbody>
    <tr>
        <th width="20%">command-line</th>
        <td>
            --stream SIZE
        </td>
    </tr>
    </tbody>
</table>

<h2>Caveats</h2>

<p>When response streaming is enabled, <strong>streamed response contents will not be
    recorded or preserved in any way.</strong></p>

<p>When response streaming is enabled, the response body cannot be modified.</p>

<h2>Customizing Response Streaming</h2>

<p>You can also use an <a href="../scripting/inlinescripts.html">inline script</a> to customize exactly
which responses are streamed.</p>

<p>Responses that should be tagged for streaming by setting their respective .stream attribute to True:</p>

<div class="example"><div class="highlight"><pre><span class="k">def</span> <span class="nf">responseheaders</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enables streaming for all responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>

<div class="example_legend">(examples/stream.py)</div></div>

<h2>Implementation Details</h2>

<p>When response streaming is enabled, portions of the code which would have otherwise performed changes
on the response body will see an empty response body instead (<code>libmproxy.protocol.http.CONTENT_MISSING</code>). Any modifications will be ignored.</p>

<p>Streamed responses are usually sent in chunks of 4096 bytes. If the response is sent with a <code>Transfer-Encoding:
    chunked</code> header, the response will be streamed one chunk at a time.</p>

<h2>Modifying streamed data</h2>

<p>If the <code>.stream</code> attribute is callable, .stream will work as a hook in chunk data processing.</p>

<div class="example"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This inline script modifies a streamed response.</span>
<span class="sd">If you do not need streaming, see the modify_response_body example.</span>
<span class="sd">Be aware that content replacement isn&#39;t trivial:</span>
<span class="sd">    - If the transfer encoding isn&#39;t chunked, you cannot simply change the content length.</span>
<span class="sd">    - If you want to replace all occurences of &quot;foobar&quot;, make sure to catch the cases</span>
<span class="sd">      where one chunk ends with [...]foo&quot; and the next starts with &quot;bar[...].</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    chunks is a generator that can be used to iterate over all chunks.</span>
<span class="sd">    Each chunk is a (prefix, content, suffix) tuple.</span>
<span class="sd">    For example, in the case of chunked transfer encoding: (&quot;3\r\n&quot;,&quot;foo&quot;,&quot;\r\n&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">),</span> <span class="n">suffix</span>


<span class="k">def</span> <span class="nf">responseheaders</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">modify</span>
</pre></div>

<div class="example_legend">(examples/stream_modify.py)</div></div>

<h3>See Also</h3>

<ul>
<li><a href="passthrough.html">Ignore Domains</a></li>
</ul>

            </div>
          </div>
        </div>

        <div class="container">
          <hr>

          <footer>
            <p>Â© mitmproxy project, 2015</p>
          </footer>
        </div>
    </body>
</html>
