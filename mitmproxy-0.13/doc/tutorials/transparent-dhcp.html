<!DOCTYPE html>
<html>
    <head>
        <title>mitmproxy 0.13 - Transparently proxify virtual machines</title>
        


<link  href="../01-vendor.css" type="text/css" rel="StyleSheet"/>
<link  href="../02-app.css" type="text/css" rel="StyleSheet"/>
<link  href="../syntax.css" type="text/css" rel="StyleSheet"/>

    </head>
    <body>
        <div class="navbar navbar-default navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="../index.html">
                        <img height="20px" src="../mitmproxy-long.png"/>
                    </a>
                </div>
                <div class="navbar-header navbar-right">
                    <a class="navbar-brand" hre="#">0.13 docs</a>
                </div>
            </div>
        </div>


        <div class="container">
          <div class="row">
            <div class="col-md-3">
                <ul class="nav nav-sidebar">
    <li><a href="../index.html">Introduction</a></li>
    <li><a href="../install.html">Installation</a></li>
    <li><a href="../certinstall.html">About Certificates</a></li>
    <li><a href="../howmitmproxy.html">How mitmproxy works</a></li>
    <li><a href="../modes.html">Modes of Operation</a></li>

    <li class="nav-header">Tools</li>
        <li><a href="../mitmproxy.html">mitmproxy</a></li>
        <li><a href="../mitmdump.html">mitmdump</a></li>
        <li><a href="../config.html">configuration</a></li>

    <li class="nav-header">Features</li>
        <li><a href="../features/anticache.html">Anticache</a></li>

        <li><a href="../features/filters.html">Filter expressions</a></li>
        <li><a href="../features/replacements.html">Replacements</a></li>
        <li><a href="../features/clientreplay.html">Client-side replay</a></li>
        <li><a href="../features/serverreplay.html">Server-side replay</a></li>
        <li><a href="../features/setheaders.html">Set Headers</a></li>
        <li><a href="../features/passthrough.html">Ignore Domains</a></li>
        <li><a href="../features/proxyauth.html">Proxy Authentication</a></li>
        <li><a href="../features/reverseproxy.html">Reverse proxy mode</a></li>
        <li><a href="../features/responsestreaming.html">Response Streaming</a></li>
        <li><a href="../features/socksproxy.html">SOCKS Mode</a></li>
        <li><a href="../features/sticky.html">Sticky cookies and auth</a></li>
        <li><a href="../features/tcpproxy.html">TCP Proxy</a></li>
        <li><a href="../features/upstreamproxy.html">Upstream proxy mode</a></li>
        <li><a href="../features/upstreamcerts.html">Upstream Certs</a></li>


    <li class="nav-header">Transparent Proxying</li>
        <li><a href="../transparent.html">Overview</a></li>
        <li><a href="../transparent/linux.html">Linux</a></li>
        <li><a href="../transparent/osx.html">OSX</a></li>

    <li class="nav-header">Scripting</li>
        <li><a href="../scripting/inlinescripts.html">Inline Scripts</a></li>
        <li><a href="../scripting/libmproxy.html">libmproxy</a></li>

    <li class="nav-header">Tutorials</li>
        <li><a href="30second.html">Client playback: a 30 second example</a></li>
        <li><a href="gamecenter.html">Setting highscores on Apple's GameCenter</a></li>
        <li class="active"><a href="transparent-dhcp.html">Transparently proxify virtual machines</a></li>

    <li class="nav-header">Hacking</li>
        <li><a href="../dev/architecture.html">Architecture</a></li>
        <li><a href="../dev/testing.html">Testing</a></li>
        <li><a href="../dev/sslkeylogfile.html">TLS Master Secrets</a></li>
</ul>

            </div>
            <div class="col-md-9">
                <div class="page-header">
                <h1>Transparently proxify virtual machines</h1>
                </div>
                <p>This walkthrough illustrates how to set up transparent proxying with mitmproxy. We use VirtualBox VMs with an Ubuntu proxy machine in this example, but the general principle can be applied to other setups.</p>

<ol>
<li><strong>Configure VirtualBox Network Adapters for the proxy machine</strong>
The network setup is simple:  <code>internet &lt;--&gt; proxy vm &lt;--&gt; (virtual) internal network</code>.
For the proxy machine, <em>eth0</em> represents the outgoing network. <em>eth1</em> is connected to the internal network that will be proxified, using a static ip (192.168.3.1).
<hr>VirtualBox configuration:
<img class="img-responsive" src="transparent-dhcp/step1_vbox_eth0.png"/><br><br>
<img class="img-responsive" src="transparent-dhcp/step1_vbox_eth1.png"/>
<br>Proxy VM:
<img class="img-responsive" src="transparent-dhcp/step1_proxy.png"/>
<hr></li>
<li><p><strong>Configure DHCP and DNS</strong>
We use dnsmasq to provide DHCP and DNS in our internal network.
Dnsmasq is a lightweight server designed to provide DNS (and optionally DHCP and TFTP) services to a small-scale
network.</p>

<ul>
<li>Before we get to that, we need to fix some Ubuntu quirks:
<strong>Ubuntu &gt;12.04</strong> runs an internal dnsmasq instance (listening on loopback only) by default
<a href="https://www.stgraber.org/2012/02/24/dns-in-ubuntu-12-04/">[1]</a>. For our use case, this needs to be
disabled by changing <br><code>dns=dnsmasq</code> to <code>#dns=dnsmasq</code> in <em>/etc/NetworkManager/NetworkManager.conf</em>
and running <code>sudo restart network-manager</code> afterwards.</li>
<li>Now, dnsmasq can be be installed and configured:
<code>sudo apt-get install dnsmasq</code>
Replace <em>/etc/dnsmasq.conf</em> with the following configuration:
<pre># Listen for DNS requests on the internal network
interface=eth1
# Act as a DHCP server, assign IP addresses to clients
dhcp-range=192.168.3.10,192.168.3.100,96h
# Broadcast gateway and dns server information
dhcp-option=option:router,192.168.3.1
dhcp-option=option:dns-server,192.168.3.1
</pre>
Apply changes:
<code>sudo service dnsmasq restart</code>
<hr>
Your proxied machine's network settings should now look similar to this:
<img class="img-responsive" src="transparent-dhcp/step2_proxied_vm.png"/>
<hr></li>
</ul></li>
<li><p><strong>Set up traffic redirection to mitmproxy</strong>
To redirect traffic to mitmproxy, we need to add two iptables rules:</p>

<pre class="terminal">
iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 \
    -j REDIRECT --to-port 8080
iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 443 \
    -j REDIRECT --to-port 8080
</pre></li>
<li><p>If required, <a href="../certinstall.html">install the mitmproxy
certificates on the test device</a>.</p></li>
<li><p>Finally, we can run <code>mitmproxy -T</code>.
The proxied machine cannot to leak any data outside of HTTP or DNS requests.</p></li>
</ol>

            </div>
          </div>
        </div>

        <div class="container">
          <hr>

          <footer>
            <p>Â© mitmproxy project, 2015</p>
          </footer>
        </div>
    </body>
</html>
